<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6486368477427533"
      crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image To Grayscale - Image Tools | OOPEN AII</title>
    <meta name="description" content="Free online image to grayscale to edit, convert, and optimize your images. Works in your browser with no installation required. 100% free with no registration needed. Try it now!">
    <meta name="keywords" content="image optimizer, oopen ai, no registration, grayscale, free image editor, free online tool, image processing, online image tools, image converter, image, to, browser-based">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="../images/logo.png" type="image/png">

    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "SoftwareApplication",
      "name": "Image To Grayscale",
      "applicationCategory": "WebApplication",
      "operatingSystem": "Web",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "description": "A powerful Image To Grayscale tool that lets you edit and manipulate your images directly in your browser. No installation required and completely free to use.",
      "url": "https://openai2026.com/tools/image-to-grayscale.html",
      "provider": {
        "@type": "Organization",
        "name": "OOPEN AII",
        "url": "https://openai2026.com/"
      }
    }
    </script>
    
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo.png" alt="OOPEN AII Logo">
                </a>
                <h1>OOPEN AII</h1>
            </div>
            <nav>
                <ul>
                        <li class="active" ><a href="../index.html">Image Tools</a></li>
                        <li><a href="../encry.html">Encry Tools</a></li>
                        <li><a href="../code.html" style="display:block !important;">Code Tools</a></li>
                        <li><a href="../network.html">Network Tools</a></li>
                        <li><a href="../text.html">Text Tools</a></li>
                        <li><a href="../dav.html">Dav</a></li>
                    </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="breadcrumb">
                <a href="../index.html">Home</a> &gt; 
                <a href="../index.html">Image Tools</a> &gt; 
                <span>Image To Grayscale</span>
            </div>
            <div class="tool-container">
                <div class="tool-header">
                    <h2>Color to Grayscale Converter</h2>
                    <p>Convert any color image to black and white with adjustable settings</p>
                </div>

                <div class="tool-content">
                    <!-- Upload Section -->
                    <div class="upload-section">
                        <div class="upload-container">
                            <div class="upload-box" id="uploadBox">
                                <input type="file" id="imageUpload" accept="image/*" style="display: none;">
                                <label for="imageUpload" class="upload-label">
                                    <div class="upload-icon">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" fill="#999" viewBox="0 0 16 16">
                                            <path d="M8 1a7 7 0 1 0 0 14A7 7 0 0 0 8 1zm0 13a6 6 0 1 1 0-12 6 6 0 0 1 0 12z"/>
                                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                                        </svg>
                                    </div>
                                    <p>Drag and drop an image here, or click to select</p>
                                    <p class="upload-hint">Supports JPG, PNG, WebP, GIF, and BMP formats</p>
                                </label>
                            </div>
                            <div class="upload-info">
                                <div id="imageInfo" class="image-info"></div>
                                <div id="uploadProgress" class="upload-progress" style="display: none;">
                                    <div class="progress-bar">
                                        <div class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                    <span class="progress-text">0%</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Preview and Controls -->
                    <div class="preview-section">
                        <div class="preview-container">
                            <div class="preview-column">
                                <h3>Original Image</h3>
                                <div class="image-preview-box">
                                    <img id="originalImage" class="preview-image" src="" alt="Original image" style="display: none;">
                                    <div class="preview-placeholder">Original image will appear here</div>
                                </div>
                            </div>
                            <div class="preview-column">
                                <h3>Grayscale Image</h3>
                                <div class="image-preview-box">
                                    <canvas id="grayscaleCanvas" class="preview-canvas"></canvas>
                                    <div id="grayscalePlaceholder" class="preview-placeholder">Grayscale image will appear here</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Conversion Controls -->
                    <div class="controls-section">
                        <h3>Conversion Settings</h3>
                        <div class="control-groups">
                            <div class="control-group">
                                <label for="grayscaleMethod">Grayscale Method</label>
                                <select id="grayscaleMethod">
                                    <option value="average">Average</option>
                                    <option value="luminance" selected>Luminance (Perceptual)</option>
                                    <option value="lightness">Lightness</option>
                                    <option value="red">Red Channel Only</option>
                                    <option value="green">Green Channel Only</option>
                                    <option value="blue">Blue Channel Only</option>
                                </select>
                                <p class="control-hint">Choose how the grayscale conversion is calculated</p>
                            </div>

                            <div class="control-group">
                                <label for="brightness">Brightness</label>
                                <input type="range" id="brightness" min="-100" max="100" value="0">
                                <span class="range-value">0</span>
                                <p class="control-hint">Adjust the overall brightness of the grayscale image</p>
                            </div>

                            <div class="control-group">
                                <label for="contrast">Contrast</label>
                                <input type="range" id="contrast" min="-100" max="200" value="0">
                                <span class="range-value">0</span>
                                <p class="control-hint">Adjust the contrast of the grayscale image</p>
                            </div>

                            <div class="control-group">
                                <label for="threshold">Threshold</label>
                                <input type="range" id="threshold" min="0" max="255" value="128">
                                <span class="range-value">128</span>
                                <div class="checkbox-group">
                                    <label>
                                        <input type="checkbox" id="useThreshold" data-dependent="thresholdSlider">
                                        Apply Threshold (Binary Image)
                                    </label>
                                </div>
                                <div id="thresholdSlider" class="slider-container">
                                    <p class="control-hint">Convert to black and white based on pixel brightness threshold</p>
                                </div>
                            </div>

                            <div class="control-group">
                                <label for="tintColor">Sepia Tint</label>
                                <input type="color" id="tintColor" value="#704214">
                                <div class="checkbox-group">
                                    <label>
                                        <input type="checkbox" id="useSepia" data-dependent="sepiaIntensitySlider">
                                        Apply Sepia Effect
                                    </label>
                                </div>
                                <div id="sepiaIntensitySlider" class="slider-container" style="display: none;">
                                    <input type="range" id="sepiaIntensity" min="0" max="100" value="50">
                                    <span class="range-value">50%</span>
                                    <p class="control-hint">Adjust the intensity of the sepia effect</p>
                                </div>
                            </div>

                            <div class="control-group">
                                <label>Additional Effects</label>
                                <div class="checkbox-group">
                                    <label>
                                        <input type="checkbox" id="applyVignette">
                                        Apply Vignette
                                    </label>
                                    <label>
                                        <input type="checkbox" id="applyNoise">
                                        Add Film Grain
                                    </label>
                                    <label>
                                        <input type="checkbox" id="applySharpen">
                                        Sharpen Image
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Output Settings -->
                    <div class="output-section">
                        <h3>Output Settings</h3>
                        <div class="output-controls">
                            <div class="output-control-group">
                                <label for="outputFormat">Output Format</label>
                                <select id="outputFormat">
                                    <option value="png">PNG</option>
                                    <option value="jpeg">JPEG</option>
                                    <option value="webp">WebP</option>
                                    <option value="bmp">BMP</option>
                                </select>
                            </div>

                            <div class="output-control-group">
                                <label for="outputQuality">Quality (JPEG/WebP)</label>
                                <input type="range" id="outputQuality" min="1" max="100" value="90">
                                <span class="range-value">90%</span>
                            </div>

                            <div class="output-control-group">
                                <label for="outputName">File Name</label>
                                <input type="text" id="outputName" placeholder="Enter file name">
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="action-btn" id="convertBtn" disabled>Convert to Grayscale</button>
                        <button class="action-btn" id="resetBtn" disabled>Reset Settings</button>
                        <a href="#" class="download-btn" id="downloadBtn" disabled>Download Image</a>
                        <button class="action-btn" id="compareBtn" disabled>Compare</button>
                    </div>

                    <!-- Comparison Modal -->
                    <div id="compareModal" class="modal" style="display: none;">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>Image Comparison</h3>
                                <span class="close-modal">&times;</span>
                            </div>
                            <div class="modal-body">
                                <div class="comparison-container">
                                    <div class="comparison-slider">
                                        <div class="comparison-before">
                                            <img id="comparisonBefore" src="" alt="Before image">
                                            <div class="comparison-label">Original</div>
                                        </div>
                                        <div class="comparison-after">
                                            <img id="comparisonAfter" src="" alt="After image">
                                            <div class="comparison-label comparison-label-after">Grayscale</div>
                                        </div>
                                        <div class="comparison-divider">
                                            <div class="comparison-handle"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-info">
                    <h3>OOPEN AII</h3>
                    <p>Providing powerful image tools for all your needs. All tools are free to use and work entirely in your browser.</p>
                </div>
                <div>
                    <h3>Quick Links</h3>
                    <div class="footer-links">
                        <a href="../index.html">Home</a>
                        <a href="../contact.html">Contact Us</a>
                        <a href="../privacy.html">Privacy Policy</a>
                        <a href="../terms.html">User Rights</a>
                    </div>
                </div>
            </div>
            <div class="copyright">
                <p>© 2026 OOPEN AII. All rights reserved.</p>
                <p>Contact: tankeapp@gmail.com</p>
            </div>
        </div>
    </footer>

    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Main elements
            const uploadBox = document.getElementById('uploadBox');
            const imageUpload = document.getElementById('imageUpload');
            const imageInfo = document.getElementById('imageInfo');
            const uploadProgress = document.getElementById('uploadProgress');
            const originalImage = document.getElementById('originalImage');
            const grayscaleCanvas = document.getElementById('grayscaleCanvas');
            const grayscalePlaceholder = document.getElementById('grayscalePlaceholder');
            const convertBtn = document.getElementById('convertBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const compareBtn = document.getElementById('compareBtn');
            const compareModal = document.getElementById('compareModal');
            const closeModal = document.querySelector('.close-modal');
            const comparisonBefore = document.getElementById('comparisonBefore');
            const comparisonAfter = document.getElementById('comparisonAfter');
            const comparisonDivider = document.querySelector('.comparison-divider');
            
            // Control elements
            const grayscaleMethod = document.getElementById('grayscaleMethod');
            const brightness = document.getElementById('brightness');
            const contrast = document.getElementById('contrast');
            const threshold = document.getElementById('threshold');
            const useThreshold = document.getElementById('useThreshold');
            const thresholdSlider = document.getElementById('thresholdSlider');
            const useSepia = document.getElementById('useSepia');
            const sepiaIntensitySlider = document.getElementById('sepiaIntensitySlider');
            const sepiaIntensity = document.getElementById('sepiaIntensity');
            const tintColor = document.getElementById('tintColor');
            const applyVignette = document.getElementById('applyVignette');
            const applyNoise = document.getElementById('applyNoise');
            const applySharpen = document.getElementById('applySharpen');
            
            // Output settings
            const outputFormat = document.getElementById('outputFormat');
            const outputQuality = document.getElementById('outputQuality');
            const outputName = document.getElementById('outputName');
            
            // Range value displays
            const rangeValues = document.querySelectorAll('.range-value');
            
            const ctx = grayscaleCanvas.getContext('2d');
            let currentImage = null;
            let isDragging = false;
            
            // Initialize event listeners
            initEventListeners();
            
            function initEventListeners() {
                // Upload handling
                uploadBox.addEventListener('dragover', handleDragOver);
                uploadBox.addEventListener('dragleave', handleDragLeave);
                uploadBox.addEventListener('drop', handleDrop);
                imageUpload.addEventListener('change', handleFileSelect);
                
                // Control events
                grayscaleMethod.addEventListener('change', convertToGrayscale);
                brightness.addEventListener('input', updateRangeValue);
                brightness.addEventListener('change', convertToGrayscale);
                contrast.addEventListener('input', updateRangeValue);
                contrast.addEventListener('change', convertToGrayscale);
                threshold.addEventListener('input', updateRangeValue);
                threshold.addEventListener('change', convertToGrayscale);
                useThreshold.addEventListener('change', toggleThreshold);
                useSepia.addEventListener('change', toggleSepia);
                sepiaIntensity.addEventListener('input', updateRangeValue);
                sepiaIntensity.addEventListener('change', convertToGrayscale);
                tintColor.addEventListener('input', convertToGrayscale);
                applyVignette.addEventListener('change', convertToGrayscale);
                applyNoise.addEventListener('change', convertToGrayscale);
                applySharpen.addEventListener('change', convertToGrayscale);
                
                // Output settings
                outputFormat.addEventListener('change', updateDownloadLink);
                outputQuality.addEventListener('input', updateRangeValue);
                outputQuality.addEventListener('change', updateDownloadLink);
                outputName.addEventListener('input', updateDownloadLink);
                
                // Action buttons
                convertBtn.addEventListener('click', convertToGrayscale);
                resetBtn.addEventListener('click', resetSettings);
                downloadBtn.addEventListener('click', function(e) {
                e.preventDefault(); // 防止a标签的默认行为
                
                if (!this.href) {
                    Utils.showNotification('No image available to download', 'error');
                    return;
                }
                
                // 创建临时下载链接以确保下载正常工作
                const tempLink = document.createElement('a');
                tempLink.href = this.href;
                tempLink.download = this.download || 'image-to-grayscale.png';
                tempLink.style.display = 'none';
                
                document.body.appendChild(tempLink);
                tempLink.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(tempLink);
                }, 100);
            });
            }
            
            function handleDragOver(e) {
                e.preventDefault();
                uploadBox.classList.add('dragover');
            }
            
            function handleDragLeave() {
                uploadBox.classList.remove('dragover');
            }
            
            function handleDrop(e) {
                e.preventDefault();
                uploadBox.classList.remove('dragover');
                
                if (e.dataTransfer.files.length > 0) {
                    processFile(e.dataTransfer.files[0]);
                }
            }
            
            function handleFileSelect(e) {
                if (e.target.files.length > 0) {
                    processFile(e.target.files[0]);
                }
            }
            
            function processFile(file) {
                // Check file type
                if (!file.type.match('image.*')) {
                    Utils.showNotification('Please select an image file!', 'error');
                    return;
                }
                
                // Show progress bar
                uploadProgress.style.display = 'block';
                const progressBar = uploadProgress.querySelector('.progress-fill');
                const progressText = uploadProgress.querySelector('.progress-text');
                
                // Simulate progress
                let progress = 0;
                const progressInterval = setInterval(() => {
                    progress += 5;
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${progress}%`;
                    
                    if (progress >= 90) {
                        clearInterval(progressInterval);
                    }
                }, 50);
                
                // Read file
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    currentImage = new Image();
                    currentImage.onload = function() {
                        // Update UI
                        originalImage.src = e.target.result;
                        originalImage.style.display = 'block';
                        originalImage.parentElement.classList.add('has-image');
                        
                        // Show image info
                        imageInfo.innerHTML = `
                            <p><strong>File Name:</strong> ${file.name}</p>
                            <p><strong>Dimensions:</strong> ${currentImage.width} × ${currentImage.height}</p>
                            <p><strong>Size:</strong> ${formatFileSize(file.size)}</p>
                            <p><strong>Type:</strong> ${file.type}</p>
                        `;
                        
                        // Complete progress
                        clearInterval(progressInterval);
                        progressBar.style.width = '100%';
                        progressText.textContent = '100%';
                        setTimeout(() => {
                            uploadProgress.style.display = 'none';
                        }, 500);
                        
                        // Enable buttons
                        convertBtn.disabled = false;
                        resetBtn.disabled = false;
                        
                        // Set default output name
                        outputName.value = file.name.replace(/\.[^/.]+$/, '');
                        
                        // Initial conversion
                        convertToGrayscale();
                    };
                    
                    currentImage.src = e.target.result;
                };
                
                reader.onerror = function() {
                    clearInterval(progressInterval);
                    uploadProgress.style.display = 'none';
                    Utils.showNotification('Error reading image file!', 'error');
                };
                
                reader.readAsDataURL(file);
            }
            
            function convertToGrayscale() {
                if (!currentImage) return;
                
                // Set canvas dimensions
                grayscaleCanvas.width = currentImage.width;
                grayscaleCanvas.height = currentImage.height;
                
                // Draw original image
                ctx.drawImage(currentImage, 0, 0);
                
                // Get image data
                const imageData = ctx.getImageData(0, 0, grayscaleCanvas.width, grayscaleCanvas.height);
                const data = imageData.data;
                
                // Apply grayscale conversion
                const method = grayscaleMethod.value;
                const useSepiaEffect = useSepia.checked;
                const sepiaAmount = sepiaIntensity.value / 100;
                const applyThreshold = useThreshold.checked;
                const thresholdValue = threshold.value;
                const tint = hexToRgb(tintColor.value);
                
                for (let i = 0; i < data.length; i += 4) {
                    let r = data[i];
                    let g = data[i + 1];
                    let b = data[i + 2];
                    let gray;
                    
                    // Calculate grayscale based on method
                    switch (method) {
                        case 'average':
                            gray = (r + g + b) / 3;
                            break;
                        case 'luminance':
                            gray = 0.299 * r + 0.587 * g + 0.114 * b;
                            break;
                        case 'lightness':
                            gray = (Math.max(r, g, b) + Math.min(r, g, b)) / 2;
                            break;
                        case 'red':
                            gray = r;
                            break;
                        case 'green':
                            gray = g;
                            break;
                        case 'blue':
                            gray = b;
                            break;
                    }
                    
                    // Apply sepia effect
                    if (useSepiaEffect) {
                        let newR = Math.min(255, (gray * (1 - sepiaAmount)) + ((gray * 0.393 + gray * 0.769 + gray * 0.189) * sepiaAmount));
                        let newG = Math.min(255, (gray * (1 - sepiaAmount)) + ((gray * 0.349 + gray * 0.686 + gray * 0.168) * sepiaAmount));
                        let newB = Math.min(255, (gray * (1 - sepiaAmount)) + ((gray * 0.272 + gray * 0.534 + gray * 0.131) * sepiaAmount));
                        
                        // Apply custom tint
                        newR = Math.min(255, newR + (tint.r - 128) * 0.5 * sepiaAmount);
                        newG = Math.min(255, newG + (tint.g - 128) * 0.5 * sepiaAmount);
                        newB = Math.min(255, newB + (tint.b - 128) * 0.5 * sepiaAmount);
                        
                        data[i] = newR;
                        data[i + 1] = newG;
                        data[i + 2] = newB;
                    } else {
                        // Set grayscale values
                        data[i] = gray;
                        data[i + 1] = gray;
                        data[i + 2] = gray;
                    }
                    
                    // Apply threshold
                    if (applyThreshold) {
                        const thresholdGray = gray >= thresholdValue ? 255 : 0;
                        data[i] = thresholdGray;
                        data[i + 1] = thresholdGray;
                        data[i + 2] = thresholdGray;
                    }
                }
                
                // Apply brightness and contrast
                applyBrightnessContrast(imageData);
                
                // Apply additional effects
                if (applySharpen.checked) {
                    applySharpening(imageData);
                }
                
                if (applyNoise.checked) {
                    applyFilmGrain(imageData);
                }
                
                if (applyVignette.checked) {
                    applyVignetteEffect(imageData);
                }
                
                // Put image data back
                ctx.putImageData(imageData, 0, 0);
                
                // Show canvas and hide placeholder
                grayscaleCanvas.style.display = 'block';
                grayscalePlaceholder.style.display = 'none';
                
                // Enable download and compare buttons
                downloadBtn.disabled = false;
                compareBtn.disabled = false;
                
                // Update download link
                updateDownloadLink();
            }
            
            function applyBrightnessContrast(imageData) {
                const data = imageData.data;
                const brightnessValue = parseInt(brightness.value);
                const contrastValue = parseInt(contrast.value);
                
                // Calculate contrast factor
                const contrastFactor = (259 * (contrastValue + 255)) / (255 * (259 - contrastValue));
                
                for (let i = 0; i < data.length; i += 4) {
                    // Apply brightness
                    data[i] = Math.min(255, Math.max(0, data[i] + brightnessValue));
                    data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + brightnessValue));
                    data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + brightnessValue));
                    
                    // Apply contrast
                    data[i] = Math.min(255, Math.max(0, contrastFactor * (data[i] - 128) + 128));
                    data[i + 1] = Math.min(255, Math.max(0, contrastFactor * (data[i + 1] - 128) + 128));
                    data[i + 2] = Math.min(255, Math.max(0, contrastFactor * (data[i + 2] - 128) + 128));
                }
            }
            
            function applySharpening(imageData) {
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;
                const tempData = new Uint8ClampedArray(data);
                
                // Sharpening kernel
                const kernel = [
                    0, -1, 0,
                    -1, 5, -1,
                    0, -1, 0
                ];
                
                for (let y = 1; y < height - 1; y++) {
                    for (let x = 1; x < width - 1; x++) {
                        let r = 0, g = 0, b = 0;
                        
                        for (let ky = -1; ky <= 1; ky++) {
                            for (let kx = -1; kx <= 1; kx++) {
                                const kernelIndex = (ky + 1) * 3 + (kx + 1);
                                const pxIndex = ((y + ky) * width + (x + kx)) * 4;
                                
                                r += tempData[pxIndex] * kernel[kernelIndex];
                                g += tempData[pxIndex + 1] * kernel[kernelIndex];
                                b += tempData[pxIndex + 2] * kernel[kernelIndex];
                            }
                        }
                        
                        const index = (y * width + x) * 4;
                        data[index] = Math.min(255, Math.max(0, r));
                        data[index + 1] = Math.min(255, Math.max(0, g));
                        data[index + 2] = Math.min(255, Math.max(0, b));
                    }
                }
            }
            
            function applyFilmGrain(imageData) {
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const noise = Math.floor(Math.random() * 10) - 5;
                    data[i] = Math.min(255, Math.max(0, data[i] + noise));
                    data[i + 1] = Math.min(255, Math.max(0, data[i + 1] + noise));
                    data[i + 2] = Math.min(255, Math.max(0, data[i + 2] + noise));
                }
            }
            
            function applyVignetteEffect(imageData) {
                const width = imageData.width;
                const height = imageData.height;
                const data = imageData.data;
                
                const centerX = width / 2;
                const centerY = height / 2;
                const maxDist = Math.sqrt(centerX * centerX + centerY * centerY);
                
                for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                        const dist = Math.sqrt(Math.pow(x - centerX, 2) + Math.pow(y - centerY, 2));
                        const vignette = 1 - Math.pow(dist / maxDist, 2) * 0.6;
                        
                        const index = (y * width + x) * 4;
                        data[index] *= vignette;
                        data[index + 1] *= vignette;
                        data[index + 2] *= vignette;
                    }
                }
            }
            
            function updateDownloadLink() {
                if (!currentImage) return;
                
                const format = outputFormat.value;
                const quality = parseInt(outputQuality.value) / 100;
                let filename = outputName.value || 'grayscale-image';
                
                // Ensure filename has correct extension
                filename = filename.replace(/\.[^/.]+$/, '') + '.' + format;
                
                // Generate data URL
                const mimeType = `image/${format}`;
                let dataURL;
                
                if (format === 'jpeg' || format === 'webp') {
                    dataURL = grayscaleCanvas.toDataURL(mimeType, quality);
                } else {
                    dataURL = grayscaleCanvas.toDataURL(mimeType);
                }
                
                downloadBtn.href = dataURL;
                downloadBtn.download = filename;
            }
            
            function downloadImage(e) {
                e.preventDefault(); // 防止a标签的默认行为
                
                if (!downloadBtn.href) {
                    Utils.showNotification('No image available to download', 'error');
                    return;
                }
                
                // 创建临时下载链接以确保下载正常工作
                const tempLink = document.createElement('a');
                tempLink.href = downloadBtn.href;
                tempLink.download = downloadBtn.download || 'grayscale-image.png';
                tempLink.style.display = 'none';
                
                document.body.appendChild(tempLink);
                tempLink.click();
                
                // 清理
                setTimeout(() => {
                    document.body.removeChild(tempLink);
                }, 100);
                
                Utils.showNotification('Image downloaded successfully!');
            }
            
            function showComparison() {
                comparisonBefore.src = originalImage.src;
                comparisonAfter.src = grayscaleCanvas.toDataURL();
                
                // Set the initial position of the divider
                comparisonDivider.style.left = '50%';
                comparisonAfter.style.clipPath = 'inset(0 0 0 50%)';
                
                compareModal.style.display = 'block';
            }
            
            function closeComparisonModal() {
                compareModal.style.display = 'none';
            }
            
            function handleOutsideClick(e) {
                if (e.target === compareModal) {
                    closeComparisonModal();
                }
            }
            
            function startComparisonDrag() {
                isDragging = true;
            }
            
            function handleComparisonDrag(e) {
                if (!isDragging) return;
                
                const slider = document.querySelector('.comparison-slider');
                const rect = slider.getBoundingClientRect();
                const position = ((e.clientX - rect.left) / rect.width) * 100;
                const clampedPosition = Math.max(0, Math.min(100, position));
                
                comparisonDivider.style.left = `${clampedPosition}%`;
                comparisonAfter.style.clipPath = `inset(0 0 0 ${clampedPosition}%)`;
            }
            
            function endComparisonDrag() {
                isDragging = false;
            }
            
            function resetSettings() {
                // Reset all controls to default values
                grayscaleMethod.value = 'luminance';
                brightness.value = 0;
                contrast.value = 0;
                threshold.value = 128;
                useThreshold.checked = false;
                useSepia.checked = false;
                sepiaIntensity.value = 50;
                tintColor.value = '#704214';
                applyVignette.checked = false;
                applyNoise.checked = false;
                applySharpen.checked = false;
                outputFormat.value = 'png';
                outputQuality.value = 90;
                
                // Update display values
                updateRangeValue.call(brightness);
                updateRangeValue.call(contrast);
                updateRangeValue.call(threshold);
                updateRangeValue.call(sepiaIntensity);
                updateRangeValue.call(outputQuality);
                
                // Toggle visibility
                toggleThreshold();
                toggleSepia();
                
                // Re-convert image
                convertToGrayscale();
                
                Utils.showNotification('Settings reset to default!');
            }
            
            function toggleThreshold() {
                thresholdSlider.style.display = useThreshold.checked ? 'block' : 'none';
                if (currentImage) {
                    convertToGrayscale();
                }
            }
            
            function toggleSepia() {
                sepiaIntensitySlider.style.display = useSepia.checked ? 'block' : 'none';
                if (currentImage) {
                    convertToGrayscale();
                }
            }
            
            function updateRangeValue() {
                const value = this.value;
                const suffix = this.id === 'sepiaIntensity' || this.id === 'outputQuality' ? '%' : '';
                
                // Find the corresponding range value display
                let rangeValue;
                if (this === brightness) rangeValue = rangeValues[0];
                else if (this === contrast) rangeValue = rangeValues[1];
                else if (this === threshold) rangeValue = rangeValues[2];
                else if (this === sepiaIntensity) rangeValue = rangeValues[3];
                else if (this === outputQuality) rangeValue = rangeValues[4];
                
                if (rangeValue) {
                    rangeValue.textContent = value + suffix;
                }
            }
            
            // Helper functions
            function formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
            
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }
        });
    </script>
    <style>
        .upload-section {
            margin-bottom: 30px;
        }
        
        .upload-container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .upload-box {
            border: 2px dashed #ddd;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            transition: all 0.3s;
            background-color: #f9f9f9;
        }
        
        .upload-box.dragover {
            border-color: #3498db;
            background-color: #e8f4fd;
        }
        
        .upload-label {
            display: block;
            cursor: pointer;
        }
        
        .upload-icon {
            margin-bottom: 20px;
        }
        
        .upload-box p {
            margin: 10px 0;
            color: #666;
        }
        
        .upload-hint {
            font-size: 14px;
            color: #999;
        }
        
        .image-info {
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .upload-progress {
            margin-top: 20px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: #3498db;
            transition: width 0.3s;
        }
        
        .progress-text {
            display: block;
            text-align: center;
            margin-top: 5px;
            font-size: 14px;
            color: #666;
        }
        
        .preview-section {
            margin-bottom: 30px;
        }
        
        .preview-container {
            display: flex;
            gap: 20px;
            justify-content: space-between;
        }
        
        .preview-column {
            flex: 1;
        }
        
        .preview-column h3 {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .image-preview-box {
            position: relative;
            width: 100%;
            min-height: 300px;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            background-color: #f8f8f8;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .preview-image,
        .preview-canvas {
            max-width: 100%;
            max-height: 500px;
            display: none;
        }
        
        .image-preview-box.has-image .preview-placeholder {
            display: none;
        }
        
        .preview-placeholder {
            text-align: center;
            color: #999;
            padding: 20px;
        }
        
        .controls-section {
            margin-bottom: 30px;
        }
        
        .control-groups {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }
        
        .control-group {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
        }
        
        .control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .control-group select,
        .control-group input[type="color"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        
        .control-group input[type="range"] {
            width: 100%;
            margin-bottom: 5px;
        }
        
        .range-value {
            display: inline-block;
            min-width: 40px;
            text-align: right;
            font-weight: bold;
        }
        
        .control-hint {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        
        .checkbox-group {
            margin-bottom: 10px;
        }
        
        .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 5px;
            font-weight: normal;
            cursor: pointer;
        }
        
        .slider-container {
            margin-top: 10px;
        }
        
        .output-section {
            margin-bottom: 30px;
        }
        
        .output-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        
        .output-control-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        
        .output-control-group select,
        .output-control-group input[type="text"] {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .output-control-group input[type="range"] {
            width: 100%;
        }
        
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.9);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .comparison-container {
            position: relative;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .comparison-slider {
            position: relative;
            width: 100%;
            overflow: hidden;
            border-radius: 4px;
        }
        
        .comparison-before,
        .comparison-after {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        
        .comparison-after {
            clip-path: inset(0 0 0 50%);
        }
        
        .comparison-before img,
        .comparison-after img {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .comparison-divider {
            position: absolute;
            top: 0;
            bottom: 0;
            left: 50%;
            width: 2px;
            background-color: white;
            cursor: ew-resize;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }
        
        .comparison-handle {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 30px;
            height: 30px;
            background-color: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            cursor: ew-resize;
        }
        
        .comparison-handle::before {
            content: '⇄';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
        }
        
        .comparison-label {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        .comparison-label-after {
            right: 20px;
            left: auto;
        }
        
        @media (max-width: 768px) {
            .preview-container {
                flex-direction: column;
            }
            
            .control-groups,
            .output-controls {
                grid-template-columns: 1fr;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .modal-content {
                margin: 10% auto;
                max-width: 95%;
                max-height: 80%;
            }
        }
    </style>
</body>
</html>