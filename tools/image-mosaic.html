<!DOCTYPE html>
<html lang="en">
<head>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6486368477427533"
      crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Image Mosaic Tool - OOPEN AII</title>
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" href="../images/logo.png" type="image/png">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="container">
            <div class="logo">
                <a href="../index.html">
                    <img src="../images/logo.png" alt="OOPEN AII Logo">
                </a>
                <h1>OOPEN AII</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="../index.html">Image Tools</a></li>
                    <li><a href="../dav.html">Dav</a></li>
                    <li><a href="../about.html">About</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <div class="container">
            <div class="tool-container">
                <div class="tool-header">
                    <h2>Image Mosaic Tool</h2>
                    <p>Apply mosaic effect to your images</p>
                </div>

                <div class="tool-content">
                    <!-- Upload Area -->
                    <div class="upload-area" id="uploadArea">
                        <input type="file" id="imageUpload" accept="image/*">
                        <div class="upload-icon">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                            </svg>
                        </div>
                        <p>Drag and drop your image here, or</p>
                        <button class="upload-btn" onclick="document.getElementById('imageUpload').click()">Select Image</button>
                    </div>

                    <!-- Options -->
                    <div class="options">
                        <div class="option-row">
                            <div class="option-group">
                                <label for="mosaicSize">Mosaic Size</label>
                                <input type="range" id="mosaicSize" min="2" max="50" value="10">
                                <span id="mosaicSizeValue">10px</span>
                            </div>

                            <div class="option-group">
                                <label for="mosaicType">Mosaic Type</label>
                                <select id="mosaicType">
                                    <option value="block">Block Mosaic</option>
                                    <option value="average">Color Average</option>
                                    <option value="random">Random Blocks</option>
                                </select>
                            </div>
                        </div>

                        <div class="option-group">
                            <label>Mosaic Mode</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="mosaicMode" value="full" checked>
                                    Full Image
                                </label>
                                <label>
                                    <input type="radio" name="mosaicMode" value="selection">
                                    Selected Area
                                </label>
                            </div>
                        </div>

                        <div class="option-group" id="selectionOptions" style="display: none;">
                            <label>Selection Options</label>
                            <div class="checkbox-group">
                                <label>
                                    <input type="checkbox" id="showGrid">
                                    Show Grid
                                </label>
                                <label>
                                    <input type="checkbox" id="keepAspectRatio">
                                    Keep Aspect Ratio
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Preview Area -->
                    <div class="preview">
                        <h3>Preview</h3>
                        <div class="preview-container">
                            <canvas id="previewCanvas" style="display: none; max-width: 100%;"></canvas>
                            <div id="selectionArea" style="display: none; position: absolute; border: 2px dashed #333; background-color: rgba(255,255,255,0.3);"></div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-buttons">
                        <button class="action-btn" id="applyMosaicBtn">Apply Mosaic</button>
                        <button class="action-btn" id="resetBtn">Reset</button>
                        <a href="#" class="download-btn" id="downloadBtn" style="display: none;">Download Image</a>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer>
        <div class="container">
            <div class="footer-links">
                <a href="../pages/contact.html">Contact Us</a>
                <a href="../pages/privacy.html">Privacy Policy</a>
                <a href="../pages/terms.html">User Rights</a>
            </div>
            <div class="copyright">
                <p>&copy; 2026 OOPEN AII. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script src="../js/main.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const imageUpload = document.getElementById('imageUpload');
            const uploadArea = document.getElementById('uploadArea');
            const mosaicSize = document.getElementById('mosaicSize');
            const mosaicSizeValue = document.getElementById('mosaicSizeValue');
            const mosaicType = document.getElementById('mosaicType');
            const mosaicMode = document.querySelectorAll('input[name="mosaicMode"]');
            const selectionOptions = document.getElementById('selectionOptions');
            const showGrid = document.getElementById('showGrid');
            const keepAspectRatio = document.getElementById('keepAspectRatio');
            const previewCanvas = document.getElementById('previewCanvas');
            const selectionArea = document.getElementById('selectionArea');
            const applyMosaicBtn = document.getElementById('applyMosaicBtn');
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            
            const ctx = previewCanvas.getContext('2d');
            let originalImage = null;
            let canvasImage = null;
            let isSelecting = false;
            let startX, startY, endX, endY;
            let selectionRect = { x: 0, y: 0, width: 0, height: 0 };
            
            // Set up drag and drop
            Utils.setupDragAndDrop(uploadArea, imageUpload, null);
            
            // Update mosaic size display
            mosaicSize.addEventListener('input', function() {
                mosaicSizeValue.textContent = `${this.value}px`;
                if (canvasImage) {
                    const mode = document.querySelector('input[name="mosaicMode"]:checked').value;
                    if (mode === 'full') {
                        applyMosaicEffect();
                    }
                }
            });
            
            // Toggle selection options
            mosaicMode.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'selection') {
                        selectionOptions.style.display = 'block';
                        selectionArea.style.display = 'block';
                        if (canvasImage) {
                            resetCanvas();
                        }
                    } else {
                        selectionOptions.style.display = 'none';
                        selectionArea.style.display = 'none';
                        if (canvasImage) {
                            applyMosaicEffect();
                        }
                    }
                });
            });
            
            // Handle file upload
            imageUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        const img = new Image();
                        img.onload = function() {
                            originalImage = img;
                            
                            // Resize image to fit canvas while maintaining aspect ratio
                            const MAX_WIDTH = 800;
                            const MAX_HEIGHT = 500;
                            let width = img.width;
                            let height = img.height;
                            
                            if (width > height) {
                                if (width > MAX_WIDTH) {
                                    height *= MAX_WIDTH / width;
                                    width = MAX_WIDTH;
                                }
                            } else {
                                if (height > MAX_HEIGHT) {
                                    width *= MAX_HEIGHT / height;
                                    height = MAX_HEIGHT;
                                }
                            }
                            
                            previewCanvas.width = width;
                            previewCanvas.height = height;
                            previewCanvas.style.display = 'block';
                            
                            // Draw the image
                            ctx.drawImage(img, 0, 0, width, height);
                            canvasImage = ctx.getImageData(0, 0, width, height);
                            
                            // Apply mosaic if in full mode
                            const mode = document.querySelector('input[name="mosaicMode"]:checked').value;
                            if (mode === 'full') {
                                applyMosaicEffect();
                            }
                            
                            Utils.showNotification('Image uploaded successfully!');
                        };
                        img.src = e.target.result;
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Reset canvas to original image
            function resetCanvas() {
                if (originalImage) {
                    ctx.drawImage(originalImage, 0, 0, previewCanvas.width, previewCanvas.height);
                    canvasImage = ctx.getImageData(0, 0, previewCanvas.width, previewCanvas.height);
                }
            }
            
            // Apply mosaic effect
            function applyMosaicEffect() {
                if (!canvasImage) return;
                
                const blockSize = parseInt(mosaicSize.value);
                const type = mosaicType.value;
                const mode = document.querySelector('input[name="mosaicMode"]:checked').value;
                
                // Create a copy of the image data
                const newImageData = ctx.createImageData(canvasImage.width, canvasImage.height);
                
                // Copy original data first
                for (let i = 0; i < newImageData.data.length; i++) {
                    newImageData.data[i] = canvasImage.data[i];
                }
                
                let startX, startY, endX, endY;
                
                if (mode === 'selection' && selectionRect.width > 0 && selectionRect.height > 0) {
                    startX = selectionRect.x;
                    startY = selectionRect.y;
                    endX = selectionRect.x + selectionRect.width;
                    endY = selectionRect.y + selectionRect.height;
                } else {
                    startX = 0;
                    startY = 0;
                    endX = canvasImage.width;
                    endY = canvasImage.height;
                }
                
                // Apply mosaic to the selected area
                for (let y = startY; y < endY; y += blockSize) {
                    for (let x = startX; x < endX; x += blockSize) {
                        // Calculate the block boundaries
                        const blockW = Math.min(blockSize, canvasImage.width - x);
                        const blockH = Math.min(blockSize, canvasImage.height - y);
                        
                        if (type === 'block') {
                            // Simple block mosaic - use top-left pixel color
                            const pixelIndex = (y * canvasImage.width + x) * 4;
                            const r = canvasImage.data[pixelIndex];
                            const g = canvasImage.data[pixelIndex + 1];
                            const b = canvasImage.data[pixelIndex + 2];
                            const a = canvasImage.data[pixelIndex + 3];
                            
                            // Fill the block with this color
                            for (let by = 0; by < blockH; by++) {
                                for (let bx = 0; bx < blockW; bx++) {
                                    const destIndex = ((y + by) * canvasImage.width + (x + bx)) * 4;
                                    newImageData.data[destIndex] = r;
                                    newImageData.data[destIndex + 1] = g;
                                    newImageData.data[destIndex + 2] = b;
                                    newImageData.data[destIndex + 3] = a;
                                }
                            }
                        } else if (type === 'average') {
                            // Color average mosaic - use average color of the block
                            let totalR = 0, totalG = 0, totalB = 0, totalA = 0;
                            let pixelCount = 0;
                            
                            for (let by = 0; by < blockH; by++) {
                                for (let bx = 0; bx < blockW; bx++) {
                                    const srcIndex = ((y + by) * canvasImage.width + (x + bx)) * 4;
                                    totalR += canvasImage.data[srcIndex];
                                    totalG += canvasImage.data[srcIndex + 1];
                                    totalB += canvasImage.data[srcIndex + 2];
                                    totalA += canvasImage.data[srcIndex + 3];
                                    pixelCount++;
                                }
                            }
                            
                            const avgR = Math.floor(totalR / pixelCount);
                            const avgG = Math.floor(totalG / pixelCount);
                            const avgB = Math.floor(totalB / pixelCount);
                            const avgA = Math.floor(totalA / pixelCount);
                            
                            // Fill the block with the average color
                            for (let by = 0; by < blockH; by++) {
                                for (let bx = 0; bx < blockW; bx++) {
                                    const destIndex = ((y + by) * canvasImage.width + (x + bx)) * 4;
                                    newImageData.data[destIndex] = avgR;
                                    newImageData.data[destIndex + 1] = avgG;
                                    newImageData.data[destIndex + 2] = avgB;
                                    newImageData.data[destIndex + 3] = avgA;
                                }
                            }
                        } else if (type === 'random') {
                            // Random blocks mosaic - use random colors from the block
                            const randomColors = [];
                            
                            // Collect some random pixel colors
                            for (let i = 0; i < Math.min(10, blockH * blockW); i++) {
                                const rx = Math.floor(Math.random() * blockW);
                                const ry = Math.floor(Math.random() * blockH);
                                const srcIndex = ((y + ry) * canvasImage.width + (x + rx)) * 4;
                                randomColors.push({
                                    r: canvasImage.data[srcIndex],
                                    g: canvasImage.data[srcIndex + 1],
                                    b: canvasImage.data[srcIndex + 2],
                                    a: canvasImage.data[srcIndex + 3]
                                });
                            }
                            
                            // Fill the block with random colors from the collected samples
                            for (let by = 0; by < blockH; by++) {
                                for (let bx = 0; bx < blockW; bx++) {
                                    const randomColor = randomColors[Math.floor(Math.random() * randomColors.length)];
                                    const destIndex = ((y + by) * canvasImage.width + (x + bx)) * 4;
                                    newImageData.data[destIndex] = randomColor.r;
                                    newImageData.data[destIndex + 1] = randomColor.g;
                                    newImageData.data[destIndex + 2] = randomColor.b;
                                    newImageData.data[destIndex + 3] = randomColor.a;
                                }
                            }
                        }
                    }
                }
                
                // Draw the mosaic image
                ctx.putImageData(newImageData, 0, 0);
            }
            
            // Set up selection area functionality
            previewCanvas.addEventListener('mousedown', function(e) {
                const mode = document.querySelector('input[name="mosaicMode"]:checked').value;
                if (mode === 'selection' && canvasImage) {
                    isSelecting = true;
                    const rect = previewCanvas.getBoundingClientRect();
                    startX = e.clientX - rect.left;
                    startY = e.clientY - rect.top;
                    endX = startX;
                    endY = startY;
                    updateSelectionArea();
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (isSelecting) {
                    const rect = previewCanvas.getBoundingClientRect();
                    endX = e.clientX - rect.left;
                    endY = e.clientY - rect.top;
                    
                    // Constrain to canvas boundaries
                    endX = Math.max(0, Math.min(endX, canvasImage.width));
                    endY = Math.max(0, Math.min(endY, canvasImage.height));
                    
                    if (keepAspectRatio.checked) {
                        // Maintain aspect ratio
                        const aspectRatio = 1; // 1:1 by default
                        const dx = endX - startX;
                        const dy = endY - startY;
                        const side = Math.max(Math.abs(dx), Math.abs(dy));
                        endX = startX + (dx > 0 ? side : -side);
                        endY = startY + (dy > 0 ? side : -side);
                        
                        // Re-constrain to canvas
                        endX = Math.max(0, Math.min(endX, canvasImage.width));
                        endY = Math.max(0, Math.min(endY, canvasImage.height));
                    }
                    
                    updateSelectionArea();
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isSelecting) {
                    isSelecting = false;
                    updateSelectionRect();
                }
            });
            
            function updateSelectionArea() {
                const x = Math.min(startX, endX);
                const y = Math.min(startY, endY);
                const width = Math.abs(endX - startX);
                const height = Math.abs(endY - startY);
                
                selectionArea.style.left = x + 'px';
                selectionArea.style.top = y + 'px';
                selectionArea.style.width = width + 'px';
                selectionArea.style.height = height + 'px';
            }
            
            function updateSelectionRect() {
                selectionRect.x = Math.min(startX, endX);
                selectionRect.y = Math.min(startY, endY);
                selectionRect.width = Math.abs(endX - startX);
                selectionRect.height = Math.abs(endY - startY);
            }
            
            // Show grid option
            showGrid.addEventListener('change', function() {
                if (this.checked) {
                    drawGrid();
                } else {
                    resetCanvas();
                    const mode = document.querySelector('input[name="mosaicMode"]:checked').value;
                    if (mode === 'full') {
                        applyMosaicEffect();
                    }
                }
            });
            
            function drawGrid() {
                if (!canvasImage) return;
                
                resetCanvas();
                
                // Draw grid lines
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.lineWidth = 0.5;
                
                const blockSize = parseInt(mosaicSize.value);
                
                // Vertical lines
                for (let x = 0; x <= canvasImage.width; x += blockSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvasImage.height);
                    ctx.stroke();
                }
                
                // Horizontal lines
                for (let y = 0; y <= canvasImage.height; y += blockSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvasImage.width, y);
                    ctx.stroke();
                }
            }
            
            // Apply mosaic button
            applyMosaicBtn.addEventListener('click', function() {
                if (!canvasImage) {
                    Utils.showNotification('Please upload an image first', 'error');
                    return;
                }
                
                applyMosaicEffect();
                
                // Hide grid after applying mosaic
                if (showGrid.checked) {
                    showGrid.checked = false;
                }
                
                downloadBtn.style.display = 'inline-block';
                Utils.showNotification('Mosaic effect applied!');
            });
            
            // Reset button
            resetBtn.addEventListener('click', function() {
                if (!originalImage) return;
                
                resetCanvas();
                
                // Reset selection area
                selectionArea.style.width = '0';
                selectionArea.style.height = '0';
                selectionRect = { x: 0, y: 0, width: 0, height: 0 };
                
                downloadBtn.style.display = 'none';
                Utils.showNotification('Image reset to original!');
            });
            
            // Download image
            downloadBtn.addEventListener('click', function() {
                if (!canvasImage) return;
                
                const dataURL = previewCanvas.toDataURL('image/png');
                downloadBtn.href = dataURL;
                downloadBtn.download = 'mosaic-image.png';
                Utils.showNotification('Image with mosaic effect downloaded!');
            });
        });
    </script>
    <style>
        .preview-container {
            position: relative;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            background-color: #f9f9f9;
            border-radius: 4px;
            overflow: hidden;
        }
        
        #selectionArea {
            cursor: move;
        }
        
        .radio-group, .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-group label, .checkbox-group label {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }
        
        @media (max-width: 768px) {
            .option-row {
                flex-direction: column;
            }
            
            .radio-group, .checkbox-group {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</body>
</html>